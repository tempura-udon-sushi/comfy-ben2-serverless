# BEN2 Serverless Worker - All Models Baked In
# For RunPod Serverless deployment
# Expected size: ~9-10 GB

FROM runpod/worker-comfyui:5.4.1-base

LABEL maintainer="your-email@example.com"
LABEL description="ComfyUI BEN2 Background Removal Worker with Safety Checks"
LABEL models="BEN2, Florence-2-base, NudeNet, Llama-3.1-8B"

WORKDIR /comfyui

# ============================================================================
# STAGE 1: Install System Dependencies
# ============================================================================

USER root

RUN apt-get update && apt-get install -y \
    wget \
    curl \
    git \
    && rm -rf /var/lib/apt/lists/*

# ============================================================================
# STAGE 2: Copy Custom Nodes
# ============================================================================

# Copy custom nodes from local installation
COPY ComfyUI/custom_nodes/ComfyUI_BEN2_ONNX /comfyui/custom_nodes/ComfyUI_BEN2_ONNX
COPY ComfyUI/custom_nodes/comfyui-florence2 /comfyui/custom_nodes/comfyui-florence2
COPY ComfyUI/custom_nodes/ComfyUI_LocalJSONExtractor /comfyui/custom_nodes/ComfyUI_LocalJSONExtractor
COPY ComfyUI/custom_nodes/comfyui-custom-scripts /comfyui/custom_nodes/comfyui-custom-scripts
COPY ComfyUI/custom_nodes/comfyui-kjnodes /comfyui/custom_nodes/comfyui-kjnodes
COPY ComfyUI/custom_nodes/save_image_no_metadata.py /comfyui/custom_nodes/save_image_no_metadata.py

# Copy workflows
COPY ComfyUI/user/default/workflows/BG_remove_BEN2_simple_1st.json /comfyui/user/default/workflows/BG_remove_BEN2_simple_1st.json
COPY ComfyUI/user/default/workflows/BG_remove_BEN2_simple_2nd.json /comfyui/user/default/workflows/BG_remove_BEN2_simple_2nd.json

# ============================================================================
# STAGE 3: Install Python Dependencies
# ============================================================================

# Install ONNX Runtime with GPU support
RUN pip install --no-cache-dir onnxruntime-gpu>=1.16.0

# Install BEN2 ONNX dependencies
RUN pip install --no-cache-dir -r /comfyui/custom_nodes/ComfyUI_BEN2_ONNX/requirements.txt

# Install Florence-2 dependencies
RUN pip install --no-cache-dir -r /comfyui/custom_nodes/comfyui-florence2/requirements.txt

# Install llama-cpp-python with CUDA support (for RTX GPUs)
# Using prebuilt wheels from jllllll's repository
RUN pip install --no-cache-dir llama-cpp-python>=0.2.26 \
    --prefer-binary \
    --extra-index-url https://jllllll.github.io/llama-cpp-python-cuBLAS-wheels/AVX2/cu121

# Install NudeNet for safety checking
RUN pip install --no-cache-dir nudenet

# Install additional dependencies
RUN pip install --no-cache-dir \
    safetensors>=0.3.0 \
    transformers>=4.39.0 \
    accelerate>=0.26.0 \
    timm \
    peft \
    matplotlib

# ============================================================================
# STAGE 4: Create Model Directories
# ============================================================================

RUN mkdir -p /comfyui/models/ben2_onnx && \
    mkdir -p /comfyui/models/llm && \
    mkdir -p /comfyui/models/LLM && \
    chmod -R 755 /comfyui/models

# ============================================================================
# STAGE 5: Download and Install Models
# ============================================================================

# Download BEN2 ONNX model (~223 MB)
RUN echo "Downloading BEN2_Base.onnx..." && \
    wget -q --show-progress \
    -O /comfyui/models/ben2_onnx/BEN2_Base.onnx \
    "https://huggingface.co/PramaLLC/BEN2/resolve/main/BEN2_Base.onnx" && \
    echo "BEN2 model downloaded successfully"

# Download Llama 3.1 8B Instruct GGUF (~5.4 GB)
# Using Q5_K_M quantization for best quality/size balance
RUN echo "Downloading Llama-3.1-8B-Instruct-Q5_K_M.gguf..." && \
    wget -q --show-progress \
    -O /comfyui/models/llm/Llama-3.1-8B-Instruct-Q5_K_M.gguf \
    "https://huggingface.co/bartowski/Meta-Llama-3.1-8B-Instruct-GGUF/resolve/main/Llama-3.1-8B-Instruct-Q5_K_M.gguf" && \
    echo "Llama 3.1 model downloaded successfully"

# Pre-download Florence-2-base model using transformers
# This caches the model so it doesn't download on first use
RUN echo "Pre-downloading Florence-2-base model..." && \
    python3 -c "from transformers import AutoModelForCausalLM, AutoProcessor; \
    print('Downloading Florence-2-base...'); \
    model = AutoModelForCausalLM.from_pretrained('microsoft/Florence-2-base', \
        trust_remote_code=True, \
        cache_dir='/comfyui/models/LLM'); \
    processor = AutoProcessor.from_pretrained('microsoft/Florence-2-base', \
        trust_remote_code=True, \
        cache_dir='/comfyui/models/LLM'); \
    print('Florence-2-base downloaded and cached')" && \
    echo "Florence-2 model cached successfully"

# Pre-trigger NudeNet model download
# NudeNet auto-downloads on first use, so we'll trigger it during build
RUN echo "Pre-downloading NudeNet model..." && \
    python3 -c "from nudenet import NudeDetector; \
    print('Downloading NudeNet...'); \
    detector = NudeDetector(); \
    print('NudeNet downloaded and ready')" && \
    echo "NudeNet model downloaded successfully"

# ============================================================================
# STAGE 6: Verify Models
# ============================================================================

RUN echo "Verifying all models are present..." && \
    ls -lh /comfyui/models/ben2_onnx/BEN2_Base.onnx && \
    ls -lh /comfyui/models/llm/Llama-3.1-8B-Instruct-Q5_K_M.gguf && \
    echo "Model verification complete"

# Display total model sizes
RUN echo "=== Model Size Summary ===" && \
    du -sh /comfyui/models/ben2_onnx/ && \
    du -sh /comfyui/models/llm/ && \
    du -sh /comfyui/models/LLM/ && \
    du -sh /comfyui/models/ && \
    echo "=========================="

# ============================================================================
# STAGE 7: Set Permissions
# ============================================================================

RUN chmod -R 755 /comfyui/models && \
    chmod -R 755 /comfyui/custom_nodes && \
    chown -R root:root /comfyui

# ============================================================================
# STAGE 8: Environment Variables
# ============================================================================

# Set environment for CUDA
ENV CUDA_VISIBLE_DEVICES=0
ENV NVIDIA_VISIBLE_DEVICES=all
ENV NVIDIA_DRIVER_CAPABILITIES=compute,utility

# HuggingFace cache location
ENV HF_HOME=/comfyui/models/LLM
ENV TRANSFORMERS_CACHE=/comfyui/models/LLM

# NudeNet cache
ENV NUDENET_HOME=/root/.NudeNet

# ============================================================================
# STAGE 9: Health Check & Metadata
# ============================================================================

# Add labels for tracking
LABEL build.date="2025-10-23"
LABEL version="1.0"
LABEL models.ben2="BEN2_Base.onnx"
LABEL models.florence="Florence-2-base"
LABEL models.llama="Llama-3.1-8B-Instruct-Q5_K_M"
LABEL models.nudenet="detector_v2_default_checkpoint"

# ============================================================================
# STAGE 10: Default Command
# ============================================================================

# Use the default ComfyUI worker start command
# This will be overridden by RunPod if needed
CMD ["/start.sh"]
